<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCAO | Sistema de Control y Avance de Obra</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f4f7;
        margin: 0;
        padding: 0;
    }
    header {
        background: #003366;
        color: #fff;
        padding: 15px;
        text-align: center;
        font-size: 22px;
        font-weight: bold;
    }
    .container {
        padding: 15px;
    }
    .card {
        background: #fff;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        margin-bottom: 20px;
    }
    input, select, button, textarea {
        width: 100%;
        padding: 8px;
        margin-top: 8px;
        margin-bottom: 15px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 15px;
    }
    button {
        background: #003366;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover {
        opacity: 0.8;
    }
    .hidden {
        display: none;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 8px;
        font-size: 14px;
    }
    th {
        background: #003366;
        color: white;
    }
</style>
</head>

<body>

<header>SCAO - Sistema de Control y Avance de Obra</header>

<div class="container">

    <!-- LOGIN -->
    <div id="loginCard" class="card">
        <h3>Ingreso</h3>
        <input type="text" id="usuario" placeholder="Usuario">
        <button onclick="login()">Ingresar</button>
    </div>

    <!-- MENU -->
    <div id="menuCard" class="card hidden">
        <h3>Bienvenido <span id="userName"></span></h3>
        <button onclick="showPPC()">Registrar Avance PPC</button>
        <button onclick="showNotas()">Registrar Nota de Campo</button>
        <button onclick="showListaNotas()">Ver Notas Emitidas</button>
        <button onclick="logout()">Salir</button>
    </div>

    <!-- PPC -->
    <div id="ppcCard" class="card hidden">
        <h3>Registro Avance PPC</h3>

        <label>Fecha</label>
        <input type="date" id="fechaPPC">

        <label>Supervisor</label>
        <select id="supervisorSelect"></select>

        <button onclick="cargarTareas()">Cargar Tareas</button>

        <div id="tareasContainer"></div>

        <button onclick="guardarPPC()">Guardar PPC</button>
        <button onclick="backMenu()">Volver</button>
    </div>

    <!-- REGISTRO NOTAS -->
    <div id="notasCard" class="card hidden">
        <h3>Registro de Nota de Campo</h3>

        <label>Emisor</label>
        <input type="text" id="notaEmisor">

        <label>Receptor</label>
        <input type="text" id="notaReceptor">

        <label>Asunto</label>
        <input type="text" id="notaAsunto">

        <label>Instrucción</label>
        <textarea id="notaInstruccion"></textarea>

        <button onclick="guardarNotaCampo()">Guardar Nota</button>
        <button onclick="backMenu()">Volver</button>
    </div>

    <!-- LISTA NOTAS -->
    <div id="listaNotasCard" class="card hidden">
        <h3>Notas Emitidas</h3>
        <table id="tablaNotas"></table>
        <button onclick="backMenu()">Volver</button>
    </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwfr3clRSqVxQsivhLgVoK_yIkzLYhsQMRM2txTwoAFGd_x0pcqO3N_9EnAo-sQKQRz/exec";  // Reemplazar por tu WebApp

// -------- LOGIN -----------
function login() {
    const user = document.getElementById("usuario").value.trim();
    if (!user) return alert("Ingrese usuario");
    localStorage.setItem("scaoUser", user);
    document.getElementById("userName").innerText = user;

    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("menuCard").classList.remove("hidden");

    cargarSupervisores();
}

function logout() {
    localStorage.clear();
    location.reload();
}

// --------- NAVEGACIÓN ----------
function showPPC() {
    document.getElementById("menuCard").classList.add("hidden");
    document.getElementById("ppcCard").classList.remove("hidden");
}
function showNotas() {
    document.getElementById("menuCard").classList.add("hidden");
    document.getElementById("notasCard").classList.remove("hidden");
}
function showListaNotas() {
    document.getElementById("menuCard").classList.add("hidden");
    document.getElementById("listaNotasCard").classList.remove("hidden");
    cargarNotasEmitidas();
}
function backMenu() {
    document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
    document.getElementById("menuCard").classList.remove("hidden");
}

// --------- SUPERVISORES ----------
async function cargarSupervisores() {
    try {
        const r = await fetch(`${API_URL}?action=getUsuarios`);
        const d = await r.json();

        const sel = document.getElementById("supervisorSelect");
        sel.innerHTML = "";

        d.usuarios.forEach(u => {
            const op = document.createElement("option");
            op.value = u;
            op.textContent = u;
            sel.appendChild(op);
        });

    } catch (e) {
        alert("Error cargando supervisores");
    }
}

// --------- CARGAR TAREAS ----------
async function cargarTareas() {
    const fecha = document.getElementById("fechaPPC").value;
    if (!fecha) return alert("Seleccione fecha");

    try {
        const r = await fetch(`${API_URL}?action=getTareasDelDia&fecha=${fecha}`);
        const d = await r.json();

        const cont = document.getElementById("tareasContainer");
        cont.innerHTML = "";

        if (!d.tareas.length) {
            cont.innerHTML = "<p>No hay tareas programadas.</p>";
            return;
        }

        d.tareas.forEach(t => {
            cont.innerHTML += `
                <div class="card">
                    <b>${t.descripcion}</b><br>
                    Unidad: ${t.unidad}<br>
                    <label>Meta día</label>
                    <input type="number" id="meta_${t.id_tarea}">
                    <label>Ejecutado</label>
                    <input type="number" id="ejecutado_${t.id_tarea}">
                    <label>Causa</label>
                    <input type="text" id="causa_${t.id_tarea}">
                    <label>Observación</label>
                    <input type="text" id="obs_${t.id_tarea}">
                </div>
            `;
        });

    } catch (e) {
        alert("Error cargando tareas");
    }
}

// --------- GUARDAR PPC ----------
async function guardarPPC() {
    const fecha = document.getElementById("fechaPPC").value;
    const supervisor = document.getElementById("supervisorSelect").value;

    const tareasDiv = document.getElementById("tareasContainer");
    const inputs = tareasDiv.querySelectorAll("input");

    if (!inputs.length) return alert("No hay tareas cargadas");

    const detalles = [];

    inputs.forEach(inp => {
        const id = inp.id.split("_")[1];
        if (!detalles.find(d => d.id_tarea === id)) {
            detalles.push({
                id_tarea: id,
                meta_dia: document.getElementById("meta_" + id).value,
                ejecutado_dia: document.getElementById("ejecutado_" + id).value,
                causa: document.getElementById("causa_" + id).value,
                observacion: document.getElementById("obs_" + id).value
            });
        }
    });

    const body = {
        action: "saveAvancePPC",
        fecha_reporte: fecha,
        supervisor,
        detalles
    };

    try {
        const r = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });

        const d = await r.json();
        alert(d.message);

    } catch (e) {
        alert("Error guardando PPC");
    }
}

// --------- GUARDAR NOTA ----------
async function guardarNotaCampo() {
    const data = {
        action: "saveNotaCampo",
        emisor: document.getElementById("notaEmisor").value,
        receptor: document.getElementById("notaReceptor").value,
        asunto: document.getElementById("notaAsunto").value,
        instruccion: document.getElementById("notaInstruccion").value
    };

    try {
        const r = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        });

        const d = await r.json();
        alert(d.message);

    } catch (e) {
        alert("Error guardando nota");
    }
}

// --------- LISTA DE NOTAS ----------
async function cargarNotasEmitidas() {
    try {
        const r = await fetch(`${API_URL}?action=getNotasCampo`);
        const d = await r.json();

        const tabla = document.getElementById("tablaNotas");
        tabla.innerHTML = `
            <tr>
                <th>Fecha</th>
                <th>Emisor</th>
                <th>Receptor</th>
                <th>Asunto</th>
                <th>Estado</th>
            </tr>
        `;

        d.notas.forEach(n => {
            tabla.innerHTML += `
                <tr>
                    <td>${n.fecha_emision}</td>
                    <td>${n.emisor}</td>
                    <td>${n.receptor}</td>
                    <td>${n.asunto}</td>
                    <td>${n.estado}</td>
                </tr>
            `;
        });

    } catch (e) {
        alert("Error cargando notas");
    }
}

</script>

</body>
</html>
